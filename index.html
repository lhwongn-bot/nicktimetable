<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentations and Papers Timetable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #2196F3;
            color: white;
            cursor: pointer;
            user-select: none;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        textarea {
            height: 60px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1976D2;
        }
        .input-row {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .input-row label {
            flex: 1;
            min-width: 120px;
        }
        .edit-mode {
            background-color: #e3f2fd;
        }
        .edit-input {
            display: none;
        }
        .edit-mode .edit-input {
            display: block;
        }
        .edit-mode .view-text {
            display: none;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .token-row {
            margin-bottom: 10px;
        }
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Presentations and Papers Timetable</h1>
    <div class="token-row">
        <label>GitHub Token: <input type="password" id="githubToken" placeholder="Enter GitHub PAT"></label>
        <button onclick="saveToken()">Save Token</button>
        <button onclick="clearToken()">Clear Token</button>
    </div>
    <div class="input-row">
        <label>Date: <input type="date" id="newDate"></label>
        <label>Type: <input type="text" id="newType" placeholder="e.g., Presentation or Paper"></label>
        <label>Content: <input type="text" id="newContent" placeholder="e.g., SSW 502 Family Influence"></label>
        <label>Notes: <textarea id="newNotes" placeholder="e.g., Prepare slides, APA citations"></textarea></label>
        <button onclick="addAssignment()">Add Assignment</button>
    </div>
    <div id="errorMessage" class="error-message"></div>
    <table id="timetable">
        <thead>
            <tr>
                <th onclick="sortTable('completed')">Completed <span id="sort-completed" class="sort-indicator"></span></th>
                <th onclick="sortTable('date')">Date <span id="sort-date" class="sort-indicator"></span></th>
                <th onclick="sortTable('type')">Type <span id="sort-type" class="sort-indicator"></span></th>
                <th onclick="sortTable('content')">Content <span id="sort-content" class="sort-indicator"></span></th>
                <th onclick="sortTable('notes')">Notes <span id="sort-notes" class="sort-indicator"></span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <button onclick="saveTimetable()">Save Timetable (Local)</button>
    <button onclick="clearTimetable()">Clear Timetable</button>
    <button onclick="syncToGitHub()">Sync with GitHub</button>
    <button onclick="loadFromGitHub()">Reload from GitHub</button>

    <script>
        // ========== GitHub Sync Settings ==========
        const GITHUB_USER = "lhwongn-bot";
        const GITHUB_REPO = "nicktimetable";
        const GITHUB_FILEPATH = "assignments.json";

        // ========== Sorting Logic ==========
        let sortState = {
            column: "date", // default sort by date
            ascending: true
        };

        function setSortIndicator() {
            const columns = ["completed", "date", "type", "content", "notes"];
            columns.forEach(col => {
                const indicator = document.getElementById("sort-" + col);
                if (!indicator) return;
                if (sortState.column === col) {
                    indicator.textContent = sortState.ascending ? "▲" : "▼";
                } else {
                    indicator.textContent = "";
                }
            });
        }

        function sortTable(column) {
            if (sortState.column === column) {
                sortState.ascending = !sortState.ascending;
            } else {
                sortState.column = column;
                sortState.ascending = true;
            }
            setSortIndicator();
            loadTimetable();
        }

        // ========== GitHub Token Handling ==========
        function getToken() {
            return localStorage.getItem("githubToken") || "";
        }
        function saveToken() {
            const t = document.getElementById("githubToken").value.trim();
            if (t) {
                localStorage.setItem("githubToken", t);
                alert("Token saved!");
            } else {
                alert("Please enter a token.");
            }
        }
        function clearToken() {
            localStorage.removeItem("githubToken");
            document.getElementById("githubToken").value = "";
            alert("Token cleared!");
        }
        document.getElementById("githubToken").value = getToken();

        // ========== Timetable Logic ==========
        function showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            setTimeout(() => errorDiv.textContent = "", 5000);
        }

        function sortAssignments(assignments) {
            const col = sortState.column;
            const asc = sortState.ascending ? 1 : -1;
            return assignments.slice().sort((a, b) => {
                let vA, vB;
                switch (col) {
                    case "date":
                        vA = new Date(a.date);
                        vB = new Date(b.date);
                        return (vA - vB) * asc;
                    case "completed":
                        vA = !!a.completed;
                        vB = !!b.completed;
                        return (vA === vB ? 0 : vA ? 1 : -1) * asc;
                    case "type":
                    case "content":
                    case "notes":
                        vA = (a[col] || "").toLowerCase();
                        vB = (b[col] || "").toLowerCase();
                        return (vA > vB ? 1 : vA < vB ? -1 : 0) * asc;
                    default:
                        return 0;
                }
            });
        }

        function loadTimetable() {
            try {
                const savedData = localStorage.getItem("assignmentsTimetable");
                const tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = "";
                if (savedData) {
                    let assignments = JSON.parse(savedData);
                    assignments = sortAssignments(assignments);
                    assignments.forEach(a => {
                        addRowToTable(a.id, a.date, a.type, a.content, a.notes, a.completed);
                    });
                }
                setSortIndicator();
            } catch (e) {
                console.error("Error loading timetable:", e);
                showError("Failed to load timetable. Please try clearing the timetable.");
            }
        }

        function addRowToTable(id, date, type, content, notes, completed = false) {
            const tableBody = document.getElementById("tableBody");
            const row = document.createElement("tr");
            row.setAttribute("data-id", id);
            row.innerHTML = `
                <td><input type="checkbox" ${completed ? "checked" : ""} onchange="updateCompletion(${id}, this.checked)"></td>
                <td>
                    <span class="view-text">${date}</span>
                    <input type="date" class="edit-input" value="${date}">
                </td>
                <td>
                    <span class="view-text">${type}</span>
                    <input type="text" class="edit-input" value="${type}">
                </td>
                <td>
                    <span class="view-text">${content}</span>
                    <input type="text" class="edit-input" value="${content}">
                </td>
                <td>
                    <span class="view-text">${notes.replace(/\n/g, "<br>")}</span>
                    <textarea class="edit-input">${notes}</textarea>
                </td>
                <td>
                    <button onclick="editRow(${id}, this)">Edit</button>
                    <button class="edit-input" onclick="saveRow(${id}, this)">Save</button>
                    <button onclick="deleteRow(${id})">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        }

        async function addAssignment() {
            const dateInput = document.getElementById("newDate").value;
            const typeInput = document.getElementById("newType").value;
            const contentInput = document.getElementById("newContent").value;
            const notesInput = document.getElementById("newNotes").value;

            if (dateInput && typeInput && contentInput) {
                try {
                    const id = Date.now();
                    const assignments = JSON.parse(localStorage.getItem("assignmentsTimetable") || "[]");
                    assignments.push({ id, date: dateInput, type: typeInput, content: contentInput, notes: notesInput, completed: false });
                    localStorage.setItem("assignmentsTimetable", JSON.stringify(assignments));
                    loadTimetable();
                    document.getElementById("newDate").value = "";
                    document.getElementById("newType").value = "";
                    document.getElementById("newContent").value = "";
                    document.getElementById("newNotes").value = "";
                    showError("");
                    await syncToGitHub(); // Sync after adding
                } catch (e) {
                    console.error("Error adding assignment:", e);
                    showError("Failed to add assignment. Please try again.");
                }
            } else {
                showError("Please fill in Date, Type, and Content fields.");
            }
        }

        function editRow(id, button) {
            const row = button.closest("tr");
            row.classList.add("edit-mode");
        }

        function saveRow(id, button) {
            const row = button.closest("tr");
            const inputs = row.querySelectorAll(".edit-input");
            const date = inputs[0].value;
            const type = inputs[1].value;
            const content = inputs[2].value;
            const notes = inputs[3].value;

            if (date && type && content) {
                try {
                    const savedData = localStorage.getItem("assignmentsTimetable");
                    let assignments = savedData ? JSON.parse(savedData) : [];
                    assignments = assignments.map(a => {
                        if (a.id === id) {
                            return { id, date, type, content, notes, completed: a.completed };
                        }
                        return a;
                    });
                    localStorage.setItem("assignmentsTimetable", JSON.stringify(assignments));
                    row.classList.remove("edit-mode");
                    loadTimetable();
                    showError("");
                    syncToGitHub(); // Sync after editing
                } catch (e) {
                    console.error("Error saving row:", e);
                    showError("Failed to save changes. Please try again.");
                }
            } else {
                showError("Please fill in Date, Type, and Content fields.");
            }
        }

        function updateCompletion(id, isChecked) {
            try {
                const savedData = localStorage.getItem("assignmentsTimetable");
                let assignments = savedData ? JSON.parse(savedData) : [];
                assignments = assignments.map(a => {
                    if (a.id === id) {
                        a.completed = isChecked;
                    }
                    return a;
                });
                localStorage.setItem("assignmentsTimetable", JSON.stringify(assignments));
                showError("");
                syncToGitHub(); // Sync after checking/unchecking
                loadTimetable(); // Needed to update sort if sorted by completed
            } catch (e) {
                console.error("Error updating completion:", e);
                showError("Failed to update completion status. Please try again.");
            }
        }

        function deleteRow(id) {
            if (confirm("Are you sure you want to delete this assignment?")) {
                try {
                    const savedData = localStorage.getItem("assignmentsTimetable");
                    let assignments = savedData ? JSON.parse(savedData) : [];
                    assignments = assignments.filter(a => a.id !== id);
                    localStorage.setItem("assignmentsTimetable", JSON.stringify(assignments));
                    loadTimetable();
                    showError("");
                    alert("Assignment deleted successfully!");
                    syncToGitHub(); // Sync after deleting
                } catch (e) {
                    console.error("Error deleting assignment:", e);
                    showError("Failed to delete assignment. Please try again.");
                }
            }
        }

        function clearTimetable() {
            if (confirm("Are you sure you want to clear the entire timetable?")) {
                try {
                    localStorage.removeItem("assignmentsTimetable");
                    document.getElementById("tableBody").innerHTML = "";
                    showError("");
                    alert("Timetable cleared successfully!");
                    syncToGitHub(); // Sync after clearing
                } catch (e) {
                    console.error("Error clearing timetable:", e);
                    showError("Failed to clear timetable. Please try again.");
                }
            }
        }

        function saveTimetable() {
            try {
                const savedData = localStorage.getItem("assignmentsTimetable");
                if (savedData) {
                    JSON.parse(savedData); // Validate JSON
                    alert("Timetable saved successfully!");
                    showError("");
                } else {
                    alert("No assignments to save!");
                }
            } catch (e) {
                console.error("Error saving timetable:", e);
                showError("Failed to save timetable. Please try again.");
            }
        }

        // ========== GitHub Sync Logic ==========

        // Load assignments from GitHub (assignments.json)
        async function loadFromGitHub() {
            try {
                showError("Loading from GitHub...");
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${GITHUB_FILEPATH}`;
                const resp = await fetch(url, { cache: "no-store" });
                if (resp.ok) {
                    const data = await resp.json();
                    localStorage.setItem("assignmentsTimetable", JSON.stringify(data));
                    loadTimetable();
                    showError("Loaded from GitHub!");
                } else {
                    showError("assignments.json not found in repo. Start by syncing your first timetable!");
                }
            } catch (e) {
                console.error(e);
                showError("Failed to load from GitHub.");
            }
        }

        // Save assignments to GitHub (assignments.json)
        async function syncToGitHub() {
            const token = getToken();
            if (!token) {
                showError("GitHub token missing! Please enter and save it above.");
                return;
            }
            const assignments = JSON.parse(localStorage.getItem("assignmentsTimetable") || "[]");
            showError("Syncing to GitHub...");
            try {
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}`;
                // Get the SHA of the existing file (if any)
                let sha = null;
                const getResp = await fetch(url, { headers: { Authorization: `token ${token}` }});
                if (getResp.ok) {
                    const json = await getResp.json();
                    sha = json.sha;
                }
                // Prepare put data
                const putData = {
                    message: "Update assignments.json",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(assignments, null, 2)))),
                };
                if (sha) putData.sha = sha;
                const putResp = await fetch(url, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Accept": "application/vnd.github.v3+json",
                    },
                    body: JSON.stringify(putData)
                });
                if (putResp.ok) {
                    showError("Synced to GitHub!");
                } else {
                    const err = await putResp.json();
                    showError("GitHub sync failed: " + (err.message || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                showError("Failed to sync to GitHub.");
            }
        }

        // Load timetable from GitHub on first load (optional)
        window.onload = async function() {
            await loadFromGitHub();
            loadTimetable();
        };
    </script>
</body>
</html>