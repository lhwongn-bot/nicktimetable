<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentations and Papers Timetable (Multi-Attachment)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .semester-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .semester-btn {
            padding: 12px 24px;
            background-color: #e0e0e0;
            color: #333;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .semester-btn:hover {
            background-color: #d0d0d0;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .semester-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
            font-weight: 600;
        }
        .semester-info {
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
        }
        .sync-status {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
        }
        .sync-status.syncing {
            background-color: #fff3cd;
            color: #856404;
        }
        .sync-status.synced {
            background-color: #d4edda;
            color: #155724;
        }
        .sync-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #2196F3;
            color: white;
            cursor: pointer;
            user-select: none;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        textarea {
            height: 60px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1976D2;
        }
        .input-row {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .input-row label {
            flex: 1;
            min-width: 120px;
        }
        .edit-mode {
            background-color: #e3f2fd;
        }
        .edit-input {
            display: none;
        }
        .edit-mode .edit-input {
            display: block;
        }
        .edit-mode .view-text {
            display: none;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .token-row {
            margin-bottom: 10px;
        }
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.9em;
        }
        .attachment-thumb {
            max-height: 40px;
            max-width: 60px;
            vertical-align: middle;
        }
        .attachment-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .attachment-list li {
            margin-bottom: 4px;
        }
        .remove-attachment-btn {
            margin-left: 8px;
            color: #f44336;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Loading...</div>
        </div>
    </div>
    
    <h1>Presentations and Papers Timetable</h1>
    <div class="semester-info">
        <span id="semesterTitle">Semester 1</span>
        <span id="syncStatus" class="sync-status"></span>
    </div>
    <div id="semesterButtons" class="semester-buttons">
        <button class="semester-btn active" onclick="switchSemester(1)">Semester 1</button>
        <button class="semester-btn" onclick="switchSemester(2)">Semester 2</button>
        <button class="semester-btn" onclick="switchSemester(3)">Semester 3</button>
        <button class="semester-btn" onclick="switchSemester(4)">Semester 4</button>
        <button class="semester-btn" onclick="switchSemester(5)">Semester 5</button>
    </div>
    <div class="token-row">
        <label>GitHub Token: <input type="password" id="githubToken" placeholder="Enter GitHub PAT"></label>
        <button onclick="saveToken()">Save Token</button>
        <button onclick="clearToken()">Clear Token</button>
    </div>
    <div class="input-row">
        <label>Date: <input type="date" id="newDate"></label>
        <label>Type: <input type="text" id="newType" placeholder="e.g., Presentation or Paper"></label>
        <label>Content: <input type="text" id="newContent" placeholder="e.g., SSW 502 Family Influence"></label>
        <label>Notes: <textarea id="newNotes" placeholder="e.g., Prepare slides, APA citations"></textarea></label>
        <label>Attachment(s): <input type="file" id="newFiles" multiple></label>
        <button onclick="addAssignment()">Add Assignment</button>
    </div>
    <div id="errorMessage" class="error-message"></div>
    <table id="timetable">
        <thead>
            <tr>
                <th onclick="sortTable('completed')">Completed <span id="sort-completed" class="sort-indicator"></span></th>
                <th onclick="sortTable('date')">Date <span id="sort-date" class="sort-indicator"></span></th>
                <th onclick="sortTable('type')">Type <span id="sort-type" class="sort-indicator"></span></th>
                <th onclick="sortTable('content')">Content <span id="sort-content" class="sort-indicator"></span></th>
                <th onclick="sortTable('notes')">Notes <span id="sort-notes" class="sort-indicator"></span></th>
                <th>Attachment(s)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <button onclick="saveTimetable()">Save Timetable (Local)</button>
    <button onclick="clearTimetable()">Clear Timetable</button>
    <button onclick="syncToGitHub()">Sync with GitHub</button>
    <button onclick="loadFromGitHub()">Reload from GitHub</button>
    <button onclick="syncAllSemesters()">Sync All Semesters</button>

    <script>
        // ========== GitHub Sync Settings ==========
        const GITHUB_USER = "lhwongn-bot";
        const GITHUB_REPO = "nicktimetable";
        
        // File size limits
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB per file
        const MAX_FILES_COUNT = 5; // Maximum number of files in a single upload
        const MAX_UPLOAD_SIZE = MAX_FILE_SIZE * MAX_FILES_COUNT; // 25MB total per upload
        const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB total data size for entire semester
        
        // Sync and retry settings
        const SYNC_DEBOUNCE_DELAY = 2000; // 2 seconds
        const MAX_RETRY_COUNT = 2;
        const RETRY_DELAY_MS = 1000; // 1 second for conflict retry
        const NETWORK_RETRY_DELAY_MS = 2000; // 2 seconds for network retry
        
        // Current semester state
        let currentSemester = 1;
        let isSyncing = false;
        let syncDebounceTimer = null;

        // ========== Semester Management ==========
        function getCurrentSemesterKey() {
            return `semester${currentSemester}_timetable`;
        }
        
        function getCurrentGitHubFilePath() {
            return `semester${currentSemester}.json`;
        }
        
        function switchSemester(semesterNum) {
            // Check for unsaved changes
            if (isSyncing) {
                showError("Please wait for current sync operation to complete.");
                return;
            }
            
            if (semesterNum === currentSemester) {
                return;
            }
            
            // Confirm switch if there might be unsaved changes
            const currentData = localStorage.getItem(getCurrentSemesterKey());
            if (currentData && !confirm(`Switch to Semester ${semesterNum}? Make sure you've synced any changes.`)) {
                return;
            }
            
            currentSemester = semesterNum;
            localStorage.setItem("currentSemester", semesterNum);
            
            // Update UI
            updateSemesterUI();
            loadTimetable();
        }
        
        function updateSemesterUI() {
            // Update buttons
            document.querySelectorAll('.semester-btn').forEach((btn, index) => {
                if (index + 1 === currentSemester) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update title
            document.getElementById('semesterTitle').textContent = `Semester ${currentSemester}`;
            updateSyncStatus('');
        }
        
        function updateSyncStatus(message, type = '') {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = 'sync-status ' + type;
        }
        
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingMessage').textContent = message;
            overlay.classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ========== Data Migration ==========
        async function migrateOldData() {
            const oldData = localStorage.getItem("assignmentsTimetable");
            const semester1Data = localStorage.getItem("semester1_timetable");
            
            if (oldData && !semester1Data) {
                console.log("Migrating old data to semester1...");
                localStorage.setItem("semester1_timetable", oldData);
                
                // Try to migrate to GitHub as well
                try {
                    const token = getToken();
                    if (token) {
                        updateSyncStatus('Migrating...', 'syncing');
                        await syncSemesterToGitHub(1, JSON.parse(oldData));
                        updateSyncStatus('Migration complete', 'synced');
                        setTimeout(() => updateSyncStatus('', ''), 3000);
                    }
                } catch (e) {
                    console.error("Migration error:", e);
                    showError(`Data migration failed: ${e.message}. Your local data is still saved.`);
                }
                
                // Show success message to user
                setTimeout(() => {
                    alert("Your data has been migrated to the new semester system! It's now in Semester 1.");
                }, 1000);
            }
        }

        // ========== Security Functions ==========
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ========== Sorting Logic ==========
        let sortState = {
            column: "date",
            ascending: true
        };

        function setSortIndicator() {
            const columns = ["completed", "date", "type", "content", "notes"];
            columns.forEach(col => {
                const indicator = document.getElementById("sort-" + col);
                if (!indicator) return;
                if (sortState.column === col) {
                    indicator.textContent = sortState.ascending ? "▲" : "▼";
                } else {
                    indicator.textContent = "";
                }
            });
        }

        function sortTable(column) {
            if (sortState.column === column) {
                sortState.ascending = !sortState.ascending;
            } else {
                sortState.column = column;
                sortState.ascending = true;
            }
            setSortIndicator();
            loadTimetable();
        }

        // ========== GitHub Token Handling ==========
        function getToken() {
            return localStorage.getItem("githubToken") || "";
        }
        function saveToken() {
            const t = document.getElementById("githubToken").value.trim();
            if (t) {
                localStorage.setItem("githubToken", t);
                alert("Token saved!");
            } else {
                alert("Please enter a token.");
            }
        }
        function clearToken() {
            localStorage.removeItem("githubToken");
            document.getElementById("githubToken").value = "";
            alert("Token cleared!");
        }
        document.getElementById("githubToken").value = getToken();

        // ========== Timetable Logic ==========
        function showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            setTimeout(() => errorDiv.textContent = "", 5000);
        }

        function sortAssignments(assignments) {
            const col = sortState.column;
            const asc = sortState.ascending ? 1 : -1;
            return assignments.slice().sort((a, b) => {
                let vA, vB;
                switch (col) {
                    case "date":
                        vA = new Date(a.date);
                        vB = new Date(b.date);
                        return (vA - vB) * asc;
                    case "completed":
                        vA = !!a.completed;
                        vB = !!b.completed;
                        return (vA === vB ? 0 : vA ? 1 : -1) * asc;
                    case "type":
                    case "content":
                    case "notes":
                        vA = (a[col] || "").toLowerCase();
                        vB = (b[col] || "").toLowerCase();
                        return (vA > vB ? 1 : vA < vB ? -1 : 0) * asc;
                    default:
                        return 0;
                }
            });
        }

        function loadTimetable() {
            try {
                const savedData = localStorage.getItem(getCurrentSemesterKey());
                const tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = "";
                if (savedData) {
                    let assignments = JSON.parse(savedData);
                    assignments = sortAssignments(assignments);
                    assignments.forEach(a => {
                        addRowToTable(
                            a.id, a.date, a.type, a.content, a.notes, a.completed,
                            a.attachments || [] // Array of {name, data}
                        );
                    });
                }
                setSortIndicator();
            } catch (e) {
                console.error("Error loading timetable:", e);
                showError("Failed to load timetable. Please try clearing the timetable.");
            }
        }

        function renderAttachmentCell(attachments) {
            if (!attachments || attachments.length === 0) return "";
            let html = '<ul class="attachment-list">';
            attachments.forEach(att => {
                if (!att || !att.data) return;
                let name = escapeHtml(att.name || "attachment");
                // Validate data URL format to prevent javascript: URLs and other attacks
                const data = att.data;
                const dataLower = data.toLowerCase();
                if (dataLower.startsWith("javascript:") || dataLower.startsWith("data:text/html")) {
                    console.warn("Potentially malicious attachment data URL detected, skipping");
                    return;
                }
                if (!data.startsWith("data:")) {
                    console.warn("Invalid attachment data URL detected, skipping");
                    return;
                }
                
                if (data.startsWith("data:image")) {
                    html += `<li><a href="${escapeHtml(data)}" target="_blank"><img src="${escapeHtml(data)}" alt="Attachment" class="attachment-thumb"></a> ${name}</li>`;
                } else if (data.startsWith("data:application/pdf")) {
                    html += `<li><a href="${escapeHtml(data)}" target="_blank" download="${name}">PDF: ${name}</a></li>`;
                } else {
                    html += `<li><a href="${escapeHtml(data)}" download="${name}">${name}</a></li>`;
                }
            });
            html += '</ul>';
            return html;
        }

        function addRowToTable(id, date, type, content, notes, completed = false, attachments = []) {
            const tableBody = document.getElementById("tableBody");
            const row = document.createElement("tr");
            row.setAttribute("data-id", id);
            let attachmentCell = renderAttachmentCell(attachments);
            row.innerHTML = `
                <td><input type="checkbox" ${completed ? "checked" : ""} onchange="updateCompletion(${id}, this.checked)"></td>
                <td>
                    <span class="view-text">${escapeHtml(date)}</span>
                    <input type="date" class="edit-input" value="${escapeHtml(date)}">
                </td>
                <td>
                    <span class="view-text">${escapeHtml(type)}</span>
                    <input type="text" class="edit-input" value="${escapeHtml(type)}">
                </td>
                <td>
                    <span class="view-text">${escapeHtml(content)}</span>
                    <input type="text" class="edit-input" value="${escapeHtml(content)}">
                </td>
                <td>
                    <span class="view-text">${escapeHtml(notes).replace(/\n/g, "<br>")}</span>
                    <textarea class="edit-input">${escapeHtml(notes)}</textarea>
                </td>
                <td>
                    <span class="view-text">${attachmentCell}</span>
                    <div class="edit-input" style="min-width:160px;">
                        <div id="edit-attachments-${id}"></div>
                        <input type="file" multiple id="editFiles-${id}">
                    </div>
                </td>
                <td>
                    <button onclick="editRow(${id}, this)">Edit</button>
                    <button class="edit-input" onclick="saveRow(${id}, this)">Save</button>
                    <button onclick="deleteRow(${id})">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        }

        async function filesInputToAttachments(input) {
            const files = input.files;
            const result = [];
            let totalSize = 0;
            
            // Validate file count
            if (files.length > MAX_FILES_COUNT) {
                throw new Error(`Too many files selected. Maximum ${MAX_FILES_COUNT} files allowed per upload.`);
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validate individual file size
                if (file.size > MAX_FILE_SIZE) {
                    throw new Error(`File "${file.name}" exceeds 5MB limit (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                }
                
                totalSize += file.size;
                
                const data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`));
                    reader.readAsDataURL(file);
                });
                result.push({ name: file.name, data });
            }
            
            // Validate cumulative uploaded file size
            if (totalSize > MAX_UPLOAD_SIZE) {
                throw new Error(`Total upload size (${(totalSize / 1024 / 1024).toFixed(2)}MB) exceeds limit of ${MAX_UPLOAD_SIZE / 1024 / 1024}MB. Please reduce the number or size of attachments.`);
            }
            
            return result;
        }
        
        function calculateTotalDataSize(assignments) {
            const jsonStr = JSON.stringify(assignments);
            // Estimate size in bytes (UTF-8)
            return new Blob([jsonStr]).size;
        }
        
        function validateTotalSize(assignments) {
            const size = calculateTotalDataSize(assignments);
            if (size > MAX_TOTAL_SIZE) {
                throw new Error(`Total data size exceeds 50MB limit (${(size / 1024 / 1024).toFixed(2)}MB). Please remove some attachments.`);
            }
            return size;
        }

        async function addAssignment() {
            const dateInput = document.getElementById("newDate").value;
            const typeInput = document.getElementById("newType").value;
            const contentInput = document.getElementById("newContent").value;
            const notesInput = document.getElementById("newNotes").value;
            const filesInput = document.getElementById("newFiles");

            if (dateInput && typeInput && contentInput) {
                try {
                    const id = Date.now();
                    const assignments = JSON.parse(localStorage.getItem(getCurrentSemesterKey()) || "[]");
                    let attachments = [];
                    if (filesInput.files && filesInput.files.length > 0) {
                        attachments = await filesInputToAttachments(filesInput);
                    }
                    
                    const newAssignment = {
                        id,
                        date: dateInput,
                        type: typeInput,
                        content: contentInput,
                        notes: notesInput,
                        completed: false,
                        attachments
                    };
                    
                    assignments.push(newAssignment);
                    
                    // Validate total size before saving
                    validateTotalSize(assignments);
                    
                    localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(assignments));
                    loadTimetable();
                    document.getElementById("newDate").value = "";
                    document.getElementById("newType").value = "";
                    document.getElementById("newContent").value = "";
                    document.getElementById("newNotes").value = "";
                    filesInput.value = "";
                    showError("");
                    debouncedSync();
                } catch (e) {
                    console.error("Error adding assignment:", e);
                    showError(e.message || "Failed to add assignment. Please try again.");
                }
            } else {
                showError("Please fill in Date, Type, and Content fields.");
            }
        }

        function editRow(id, button) {
            // Enter edit mode
            const row = button.closest("tr");
            row.classList.add("edit-mode");

            // Render editable attachments list
            const savedData = localStorage.getItem(getCurrentSemesterKey());
            let assignments = savedData ? JSON.parse(savedData) : [];
            const assignment = assignments.find(a => a.id === id);
            const editDiv = document.getElementById(`edit-attachments-${id}`);
            if (editDiv) {
                editDiv.innerHTML = "";
                if (assignment && assignment.attachments && assignment.attachments.length > 0) {
                    assignment.attachments.forEach((att, i) => {
                        const span = document.createElement("span");
                        let name = escapeHtml(att.name || "attachment");
                        const data = att.data;
                        
                        // Validate data URL format to prevent javascript: URLs and other attacks
                        const dataLower = data.toLowerCase();
                        if (dataLower.startsWith("javascript:") || dataLower.startsWith("data:text/html")) {
                            console.warn("Potentially malicious attachment data URL detected, skipping");
                            return;
                        }
                        if (!data.startsWith("data:")) {
                            console.warn("Invalid attachment data URL detected, skipping");
                            return;
                        }
                        
                        if (data.startsWith("data:image")) {
                            span.innerHTML = `<a href="${escapeHtml(data)}" target="_blank"><img src="${escapeHtml(data)}" class="attachment-thumb" alt="Attachment"></a> ${name}`;
                        } else if (data.startsWith("data:application/pdf")) {
                            span.innerHTML = `<a href="${escapeHtml(data)}" target="_blank" download="${name}">PDF: ${name}</a>`;
                        } else {
                            span.innerHTML = `<a href="${escapeHtml(data)}" download="${name}">${name}</a>`;
                        }
                        // Remove button
                        const btn = document.createElement("button");
                        btn.textContent = "✕";
                        btn.className = "remove-attachment-btn";
                        btn.title = "Remove this attachment";
                        btn.onclick = function() {
                            removeEditAttachment(id, i);
                        };
                        span.appendChild(btn);
                        editDiv.appendChild(span);
                        editDiv.appendChild(document.createElement("br"));
                    });
                }
            }
        }

        function removeEditAttachment(id, attIndex) {
            // Remove attachment at attIndex for assignment id
            const savedData = localStorage.getItem(getCurrentSemesterKey());
            let assignments = savedData ? JSON.parse(savedData) : [];
            assignments = assignments.map(a => {
                if (a.id === id && a.attachments) {
                    a.attachments.splice(attIndex, 1);
                }
                return a;
            });
            localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(assignments));
            loadTimetable();
            // Re-enter edit mode for this row
            const editButton = document.querySelector(`tr[data-id="${id}"] button`);
            if (editButton) editButton.click();
        }

        async function saveRow(id, button) {
            const row = button.closest("tr");
            const inputs = row.querySelectorAll(".edit-input");
            const date = inputs[0].value;
            const type = inputs[1].value;
            const content = inputs[2].value;
            const notes = inputs[3].value;
            const filesInput = row.querySelector('input[type="file"]');

            if (date && type && content) {
                try {
                    const savedData = localStorage.getItem(getCurrentSemesterKey());
                    let assignments = savedData ? JSON.parse(savedData) : [];
                    let newAttachments = [];
                    if (filesInput && filesInput.files && filesInput.files.length > 0) {
                        newAttachments = await filesInputToAttachments(filesInput);
                    }
                    assignments = assignments.map(a => {
                        if (a.id === id) {
                            let existingAttachments = Array.isArray(a.attachments) ? a.attachments : [];
                            a = {
                                ...a,
                                date,
                                type,
                                content,
                                notes,
                                attachments: existingAttachments.concat(newAttachments)
                            };
                        }
                        return a;
                    });
                    
                    // Validate total size before saving
                    validateTotalSize(assignments);
                    
                    localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(assignments));
                    row.classList.remove("edit-mode");
                    loadTimetable();
                    showError("");
                    debouncedSync();
                } catch (e) {
                    console.error("Error saving row:", e);
                    showError(e.message || "Failed to save changes. Please try again.");
                }
            } else {
                showError("Please fill in Date, Type, and Content fields.");
            }
        }

        function updateCompletion(id, isChecked) {
            try {
                const savedData = localStorage.getItem(getCurrentSemesterKey());
                let assignments = savedData ? JSON.parse(savedData) : [];
                assignments = assignments.map(a => {
                    if (a.id === id) {
                        a.completed = isChecked;
                    }
                    return a;
                });
                localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(assignments));
                showError("");
                debouncedSync();
                loadTimetable();
            } catch (e) {
                console.error("Error updating completion:", e);
                showError("Failed to update completion status. Please try again.");
            }
        }

        function deleteRow(id) {
            if (confirm("Are you sure you want to delete this assignment?")) {
                try {
                    const savedData = localStorage.getItem(getCurrentSemesterKey());
                    let assignments = savedData ? JSON.parse(savedData) : [];
                    assignments = assignments.filter(a => a.id !== id);
                    localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(assignments));
                    loadTimetable();
                    showError("");
                    alert("Assignment deleted successfully!");
                    debouncedSync();
                } catch (e) {
                    console.error("Error deleting assignment:", e);
                    showError("Failed to delete assignment. Please try again.");
                }
            }
        }

        function clearTimetable() {
            if (confirm("Are you sure you want to clear the entire timetable for the current semester?")) {
                try {
                    localStorage.removeItem(getCurrentSemesterKey());
                    document.getElementById("tableBody").innerHTML = "";
                    showError("");
                    alert("Timetable cleared successfully!");
                    debouncedSync();
                } catch (e) {
                    console.error("Error clearing timetable:", e);
                    showError("Failed to clear timetable. Please try again.");
                }
            }
        }

        function saveTimetable() {
            try {
                const savedData = localStorage.getItem(getCurrentSemesterKey());
                if (savedData) {
                    JSON.parse(savedData);
                    alert("Timetable saved successfully!");
                    showError("");
                } else {
                    alert("No assignments to save!");
                }
            } catch (e) {
                console.error("Error saving timetable:", e);
                showError("Failed to save timetable. Please try again.");
            }
        }

        // ========== GitHub Sync Logic ==========
        
        // Debounced sync to prevent rapid consecutive syncs
        function debouncedSync() {
            if (syncDebounceTimer) {
                clearTimeout(syncDebounceTimer);
            }
            syncDebounceTimer = setTimeout(() => {
                syncToGitHub();
            }, SYNC_DEBOUNCE_DELAY);
        }
        
        // Improved Base64 encoding for UTF-8
        function encodeBase64(str) {
            try {
                // Use TextEncoder for proper UTF-8 encoding
                const bytes = new TextEncoder().encode(str);
                const chars = [];
                bytes.forEach(byte => chars.push(String.fromCharCode(byte)));
                return btoa(chars.join(''));
            } catch (e) {
                console.error("Base64 encoding error:", e);
                // Fallback to old method
                return btoa(unescape(encodeURIComponent(str)));
            }
        }
        
        // Load assignments from GitHub for current semester
        async function loadFromGitHub() {
            if (isSyncing) {
                showError("Please wait for current sync operation to complete.");
                return;
            }
            
            try {
                isSyncing = true;
                updateSyncStatus('Loading...', 'syncing');
                showLoading('Loading from GitHub...');
                
                const filepath = getCurrentGitHubFilePath();
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${filepath}`;
                
                const resp = await fetch(url, { cache: "no-store" });
                
                if (resp.ok) {
                    const data = await resp.json();
                    localStorage.setItem(getCurrentSemesterKey(), JSON.stringify(data));
                    loadTimetable();
                    updateSyncStatus('Loaded from GitHub', 'synced');
                    setTimeout(() => updateSyncStatus('', ''), 3000);
                } else if (resp.status === 404) {
                    showError(`${filepath} not found in repo. Start by syncing your first timetable!`);
                    updateSyncStatus('', '');
                } else {
                    throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                }
            } catch (e) {
                console.error("GitHub load error:", e);
                updateSyncStatus('Load failed', 'error');
                showError(`Failed to load from GitHub: ${e.message}`);
                setTimeout(() => updateSyncStatus('', ''), 5000);
            } finally {
                isSyncing = false;
                hideLoading();
            }
        }
        
        // Sync a specific semester to GitHub
        async function syncSemesterToGitHub(semesterNum, assignments, retryCount = 0) {
            const token = getToken();
            if (!token) {
                throw new Error("GitHub token missing!");
            }
            
            const filepath = `semester${semesterNum}.json`;
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${filepath}`;
            
            try {
                // Validate total size before syncing
                validateTotalSize(assignments);
                
                // Get the SHA of the existing file (if any)
                let sha = null;
                const getResp = await fetch(url, { 
                    headers: { 
                        Authorization: `Bearer ${token}`,
                        Accept: "application/vnd.github.v3+json"
                    },
                    cache: "no-store"
                });
                
                if (getResp.ok) {
                    const json = await getResp.json();
                    sha = json.sha;
                } else if (getResp.status === 401) {
                    throw new Error("Invalid GitHub token. Please update your token.");
                } else if (getResp.status === 403) {
                    throw new Error("GitHub API rate limit exceeded or permission denied.");
                } else if (getResp.status !== 404) {
                    console.warn(`Unexpected status getting file: ${getResp.status}`);
                }
                
                // Prepare put data
                const content = JSON.stringify(assignments, null, 2);
                const putData = {
                    message: `Update ${filepath}`,
                    content: encodeBase64(content),
                };
                if (sha) putData.sha = sha;
                
                const putResp = await fetch(url, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/vnd.github.v3+json",
                    },
                    body: JSON.stringify(putData)
                });
                
                if (putResp.ok) {
                    return true;
                } else if (putResp.status === 409 && retryCount < MAX_RETRY_COUNT) {
                    // Conflict - retry with fresh SHA
                    console.log(`Conflict detected, retrying (attempt ${retryCount + 1})...`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                    return await syncSemesterToGitHub(semesterNum, assignments, retryCount + 1);
                } else {
                    const err = await putResp.json().catch(() => ({}));
                    throw new Error(err.message || `HTTP ${putResp.status}: ${putResp.statusText}`);
                }
            } catch (e) {
                // Retry on network errors
                // Network errors are typically TypeErrors or have specific keywords
                const isNetworkError = e instanceof TypeError || 
                                      e.message.toLowerCase().includes('fetch') || 
                                      e.message.toLowerCase().includes('network') ||
                                      e.message.toLowerCase().includes('failed to fetch');
                
                if (retryCount < MAX_RETRY_COUNT && isNetworkError) {
                    console.log(`Network error, retrying (attempt ${retryCount + 1})...`);
                    await new Promise(resolve => setTimeout(resolve, NETWORK_RETRY_DELAY_MS));
                    return await syncSemesterToGitHub(semesterNum, assignments, retryCount + 1);
                }
                throw e;
            }
        }
        
        // Save assignments to GitHub for current semester
        async function syncToGitHub() {
            if (isSyncing) {
                console.log("Sync already in progress, skipping...");
                return;
            }
            
            const token = getToken();
            if (!token) {
                updateSyncStatus('Token required', 'error');
                setTimeout(() => {
                    showError("Please enter and save your GitHub token above to enable sync.");
                    updateSyncStatus('', '');
                }, 100);
                return;
            }
            
            try {
                isSyncing = true;
                const assignments = JSON.parse(localStorage.getItem(getCurrentSemesterKey()) || "[]");
                
                updateSyncStatus('Syncing...', 'syncing');
                showLoading('Syncing to GitHub...');
                
                await syncSemesterToGitHub(currentSemester, assignments);
                
                updateSyncStatus('Synced', 'synced');
                setTimeout(() => updateSyncStatus('', ''), 3000);
            } catch (e) {
                console.error("GitHub sync error:", e);
                updateSyncStatus('Sync failed', 'error');
                showError(`GitHub sync failed: ${e.message}`);
                setTimeout(() => updateSyncStatus('', ''), 5000);
            } finally {
                isSyncing = false;
                hideLoading();
            }
        }
        
        // Sync all semesters to GitHub
        async function syncAllSemesters() {
            const token = getToken();
            if (!token) {
                updateSyncStatus('Token required', 'error');
                setTimeout(() => {
                    showError("Please enter and save your GitHub token above to enable sync.");
                    updateSyncStatus('', '');
                }, 100);
                return;
            }
            
            if (isSyncing) {
                showError("Please wait for current sync operation to complete.");
                return;
            }
            
            if (!confirm("This will sync all 5 semesters to GitHub. Continue?")) {
                return;
            }
            
            try {
                isSyncing = true;
                showLoading('Syncing all semesters...');
                
                // Prepare all sync promises
                const syncPromises = [];
                for (let i = 1; i <= 5; i++) {
                    const key = `semester${i}_timetable`;
                    const assignments = JSON.parse(localStorage.getItem(key) || "[]");
                    syncPromises.push(
                        syncSemesterToGitHub(i, assignments)
                            .then(() => ({ semester: i, success: true }))
                            .catch(e => ({ semester: i, success: false, error: e.message }))
                    );
                }
                
                // Sync all semesters in parallel
                const results = await Promise.all(syncPromises);
                
                // Process results
                const successCount = results.filter(r => r.success).length;
                const errors = results
                    .filter(r => !r.success)
                    .map(r => `Semester ${r.semester}: ${r.error || 'Unknown error'}`);
                
                hideLoading();
                
                if (errors.length === 0) {
                    alert(`Successfully synced all ${successCount} semesters!`);
                    updateSyncStatus('All synced', 'synced');
                    setTimeout(() => updateSyncStatus('', ''), 3000);
                } else {
                    alert(`Synced ${successCount} semesters.\nErrors:\n${errors.join('\n')}`);
                    updateSyncStatus('Partial sync', 'error');
                    setTimeout(() => updateSyncStatus('', ''), 5000);
                }
            } catch (e) {
                console.error("Sync all error:", e);
                showError(`Failed to sync all semesters: ${e.message}`);
                updateSyncStatus('Sync failed', 'error');
                setTimeout(() => updateSyncStatus('', ''), 5000);
            } finally {
                isSyncing = false;
                hideLoading();
            }
        }

        // Load timetable from GitHub on first load (optional)
        window.onload = async function() {
            // Restore last selected semester
            const savedSemester = localStorage.getItem("currentSemester");
            if (savedSemester) {
                currentSemester = parseInt(savedSemester);
            }
            
            // Migrate old data if needed
            await migrateOldData();
            
            // Update UI and load data
            updateSemesterUI();
            await loadFromGitHub();
            loadTimetable();
        };
    </script>
</body>
</html>